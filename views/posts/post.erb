<%
  post_id = pr[:post_id]
  post    = $posts.get(post_id)
  splat   = pr['splat']
  handle  = splat[0]
  owner   = $users.get(handle: handle)
  is_owner= owner && owner[:_id] == cuid
  created_at = nice_date(post['created_at']) rescue '' 
%>

<div id='editor' class="<%='is_owner' if is_owner %>">  
  <h1 class='title refreshOnChange' autofocus>
    <% if is_owner %>
      <textarea onkeyup=savePost() rows=1 class='editable_textarea title_textarea' autofocus placeholder='כותרת'><%= post['title'] %></textarea>
    <% else %>
      <textarea readonly           rows=1 class='editable_textarea title_textarea'><%= post['title'] %></textarea>
    <% end %>
  </h1>

  <div class='user_data rtl'>
    <span class='user_data_name'><a href='<%=$root_url%>/@<%=owner['handle']%>'><%= owner['name'] %></a>, </span>
    <span class='user_data_name'><a href='<%=$root_url%><%=_req.path%>' target=_blank><%= created_at %></a></span>
  </div>

  <div class='body refreshOnChange'>
    <% if is_owner %>
      <textarea onkeyup=savePost() class='editable_textarea body_textarea' placeholder='הסיפור שלך'><%= post['body'] %></textarea>
      <button> להוסיף תמונה </button>
    <% else %>
      <textarea readonly           class='editable_textarea body_textarea'><%= post['body'] %></textarea>
    <% end %>      
  </div>

  <%= erb :'posts/below_post_btns', locals: {post: post} if is_owner %>
</div>

<script>

var $title = $('#editor .title textarea');
var $body  = $('#editor .body textarea');

function updateServer(data) {
  return $.post('/posts/<%=post_id%>', data);
}

function savePost() {
  var btn  = $('.saved-btn');
  var data = {title: $title.val(), body: $body.val()}
  
  btn.fadeOut(0).text('');
  clearTimeout(window.savePostTimeout);
  window.savePostTimeout = setTimeout(()=>{
    btn.fadeIn('fast').text('שומר...');
    updateServer(data).then(res => { btn.text('נשמר').fadeOut(1500);})  
  },1000);
}
  
function resizeTextAreas() {
  $('textarea').each(function () {
    this.setAttribute('style', 'height:' + (this.scrollHeight) + 'px;overflow-y:hidden;');
  }).on('input', function () {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });
}

function onLoad() {
  $('[data-toggle="tooltip"]').tooltip(); // show tooltips 

  setTimeout(()=>resizeTextAreas(),500);
}

$(document).ready(onLoad);
</script>